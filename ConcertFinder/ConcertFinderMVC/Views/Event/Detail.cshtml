@model ConcertFinderMVC.Models.EventDetail

@section Header
{
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyBm8CQjlFqdYRoa3Am16rtSsAiIpdhL_nw&sensor=true"></script>
}

<div>
    @Model.Item.Titre
</div>
<div>
    @Model.Item.StartDate
</div>
<div>
    @Model.Item.Description
</div>
<div>
    @Model.Item.Rue, @Model.Item.Ville, @Model.Item.CP, @Model.Item.Pays
</div>
<div>
    @Model.Item.Salle
</div>



<div>
    @foreach (var tag in Model.Item.TagList)
    {
        <span>
            @tag
        </span>
    }

<div id="map" style="width:400px; height:400px;">


</div>
</div>

    <div>
        @if(User.Identity.IsAuthenticated)
        {
                if (!Model.Item.Valide && (ConcertFinderMVC.BusinessManagement.Tool.IsAdmin(User.Identity.Name) ||
                    ConcertFinderMVC.BusinessManagement.Tool.IsModerator(User.Identity.Name)))
                {
                    <div>
                        @Html.ActionLink("Accepter", "ValideEvent", "Event", new { idevent = Model.Item.Id }, null)
                    </div>
                    <div>
                        @Html.ActionLink("Refuser", "DenyEvent", "Admin", new { idevent = Model.Item.Id }, null)
                    </div>
                }
                if ((User.Identity.IsAuthenticated) && (ConcertFinderMVC.BusinessManagement.Tool.CreatedByMe(User.Identity.Name, Model.Item.Id) ||
                    ConcertFinderMVC.BusinessManagement.Tool.IsAdmin(User.Identity.Name) ||
                    ConcertFinderMVC.BusinessManagement.Tool.IsModerator(User.Identity.Name)))
                {
                    <div>
                        @Html.ActionLink("Editer", "CreateEvent", "Event", new { id = Model.Item.Id }, null)
                    </div>
                }   
         }
    </div>
    <div>
        <input id="direction" type="button" value="Direction" />
    </div>


    <div>
    <ul>
        @foreach(var ev in Model.Events)
        {
          <li>
            <strong>
                @ev.Titre
            </strong>
            <span>
                @ev.Ville
            </span>
            <span>
                @ev.StartDate
            </span>
          </li>  
        }
    </ul>
    </div>

@section Script
{
    <script type="text/javascript">

        function initialize() {
            var myLatlng = new google.maps.LatLng(@Model.Item.Longitude.ToString().Replace(',', '.'), @Model.Item.Latitude.ToString().Replace(',', '.'));
            var myOptions = {
                zoom: 15,
                center: myLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            var map = new google.maps.Map(document.getElementById("map"), myOptions);

            var marker = new google.maps.Marker({
                position: myLatlng,
                map: map,
                title: "@Model.Item.Salle"
            });
        }

        $("#direction").click(function (){
        
            var directionsDisplay = new google.maps.DirectionsRenderer();
            var eventLatlng = new google.maps.LatLng(@Model.Item.Longitude.ToString().Replace(',', '.'), @Model.Item.Latitude.ToString().Replace(',', '.'));
            
            var myOptions = {
                zoom: 6,
                center: eventLatlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById('map'), myOptions);

            directionsDisplay.setMap(map);

            if (navigator.geolocation)
            {
                navigator.geolocation.getCurrentPosition(function(position)
                {
                    var directionsService = new google.maps.DirectionsService();
                    var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                    var request = {
                        origin:pos, 
                        destination:eventLatlng,
                        travelMode: google.maps.DirectionsTravelMode.DRIVING
                    };
                    directionsService.route(request, function(response, status)
                    {
                        if (status == google.maps.DirectionsStatus.OK)
                        {
                            directionsDisplay.setDirections(response);
                        }
                    });
                }, function()
                {
                    handleNoGeolocation(true);
                });
            }
            else
            {
                // Browser doesn't support Geolocation
                handleNoGeolocation(false);
            }
        });

        initialize();

    </script>
}