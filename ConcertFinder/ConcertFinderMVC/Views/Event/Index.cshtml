@model ConcertFinderMVC.Models.EventsList

@section Header
{
    <script src="@Url.Content("~/Scripts/dateformat.js")" type="text/javascript"></script>
}

<div class="main float-left">
    <div class="section_title">Tous les événements</div>
    <div class="item_separator"></div>
    @foreach (ConcertFinderMVC.Models.EventItem item in Model.Events)
    {
        <div class="item" id="@item.Id">
           <div class="item_content">
            @if (item.Image != null)
            {
                <img src="@Url.Content("/ConcertFinderMVC/")@item.Image" width="125" height="160" alt="flyers" class="flyers float-left" />
            }
            else
            {
                <img src="@Url.Content("~/Content/Images/no_avatar.gif")" width="125" height="160" alt="flyers" class="flyers float-left" />
            }
             <div class="infos float-left">
                <div class="main_infos">
                      <strong class="item_titre">@item.Titre</strong>
                      <strong class="item_date float-right"></strong>
                </div>
                <div class="info1">
                    <div class="item_type float-left">@item.Type</div>
                    <div class="item_salle float-left">Salle : @item.Salle</div>
                    <div class="item_Date float-right">@item.StartDate.ToShortDateString()<br />à @item.Ville (@item.CP.Substring(0, 2))</div>
                    <div class="clear"></div>
                </div>
                <p class="item_descr">
                    @ConcertFinderMVC.BusinessManagement.Tool.Truncate(item.Description)
                </p>
                <div class="clear">
                    @Html.ActionLink("voir le détail", "Detail", "Event", new { id = item.Id }, null)
                </div>
             </div>   
            </div>
        </div>
        <div class="item_separator">
        </div>
    }
</div>
<div class="float-right">
        @Html.Partial("_LastAdded", Model.Last)
</div>
<div class="clear"></div>

@section Script
{
    <script type="text/javascript">

        $(window).scroll(function () {
            if ($(window).scrollTop() == $(document).height() - $(window).height()) {
                var url = document.URL.split("//");
                url = (url[1] ? url[1] : url[0]).split("/");
                var qtype = "";
                if (url.length > 2)
                {
                    qtype = url[2];
                }
                var id = $(".item:last").attr("id");
                $.ajax({
                    url: "http://"+url[0]+"/ConcertFinderMVC/Event/GetNextEvents",
                    data: { last_id: id, type : qtype },
                    success: function (data) {
                        for (var i = 0; i < data.length; i++) {
                            var text = "<div class='item' id='" + data[i].Id + "'>" +
                                           "<div class='item_content'>";
                            if (data[i].Image != null) {
                                text += "<img src="+"@Url.Content("/ConcertFinderMVC/")"+data[i].Image+" width='125' height='160' alt='flyers' class='flyers float-left' />";
                            }
                            else {
                                text += "<img src='"+"@Url.Content("~/Content/Images/no_avatar.gif")"+"' width='125' height='160' alt='flyers' class='flyers float-left' />";
                            }

                            var milli = data[i].StartDate.replace(/\/Date\((-?\d+)\)\//, '$1');
                            var d = new Date(parseInt(milli));

                            text += "<div class='infos float-left'>" +
                                                "<div class='main_infos'>" +
                                                      "<strong class='item_titre'>" + data[i].Titre + "</strong>" +
                                                      "<strong class='item_date float-right'></strong>" +
                                                "</div>" +
                                                "<div class='info1'>" +
                                                    "<div class='item_type float-left'>" + data[i].Type + "</div>" +
                                                    "<div class='item_salle float-left'>Salle : " + data[i].Salle + "</div>" +
                                                    "<div class='item_Date float-right'>" + dateFormat(d, "dd/mm/yyyy") + "<br />à " + data[i].Ville + " (" + data[i].CP + ")</div>" +
                                                    "<div class='clear'></div>" +
                                                "</div>" +
                                                "<p class='item_descr'>" +
                                                    data[i].Description +
                                                "</p>" +
                                                "<div class='clear'>" +
                                                    "<a href='Event/Detail/" + data[i].Id + "'>voir le détail</a>" +
                                                "</div>" +
                                             "</div>" +
                                            "</div>" +
                                        "</div>" +
                                        "<div class='item_separator'>" +
                                        "</div>";

                            $(".main").append(text);
                        }
                    },
                    dataType: "json"
                });
            }
        });

    </script>
}